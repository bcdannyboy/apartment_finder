**Overview**
This architecture defines a local-first, Python-based system with strict compliance gating and provenance-first data handling. The core pipeline is capture → extract → normalize → dedupe → rank → alert, backed by Postgres/PostGIS + pgvector and an immutable snapshot store. Only paid services allowed are Firecrawl (acquisition) and OpenAI (extraction/rerank/embeddings), with geo/commute and notifications running locally. (`architecture_kickoff.md`, `architecture_components.md`)

**Components and Interfaces**
- Source Registry and Policy Gate: stores per-domain policy classification (robots/ToS, allowed ops, rate limits) and exposes a policy-check API; blocks tasks unless `crawl_allowed` or `manual_only` for imports; assigns policy_id to every acquisition task. Interfaces: policy check, policy metadata lookup. (`architecture_components.md`, `architecture_kickoff.md`)
- Acquisition Orchestrator: plans searches/sweep grids and generates Search/Map/Crawl/Scrape/Import tasks; enforces per-domain budgets/cadence; consumes SearchSpecs and policy data. Interfaces: task planner API, emits tasks to scheduler/workers. (`architecture_components.md`, `architecture_kickoff.md`)
- Connector Interface / Registry: per-source connector contract with `enumerate(seeds)`, `fetch(item)`, `extract(snapshot)`, `check_status(item)`; supports seeds/sitemaps and compliance mode. Interfaces: called by acquisition to enumerate/fetch; extraction hook is defined but overlaps with central Extraction Service. (`architecture_kickoff.md`, `_dev_docs/apt_judge.md`)
- Scheduler + Workers/Queue: adaptive cadence, two-lane queue (index vs detail), backoff/retries, per-domain queues; executes acquisition tasks and triggers pipeline stages. Interfaces: receives tasks from orchestrator; outputs snapshots and status. (`architecture_kickoff.md`, `architecture_components.md`)
- Firecrawl Adapter: single wrapper for Firecrawl API; enforces formats, changeTracking, maxAge caching, crawl scoping; logs request metadata for audit. Interfaces: task → Firecrawl request → raw artifacts + metadata. (`architecture_components.md`, `architecture_kickoff.md`)
- Snapshot Store (Object Store + DocumentSnapshot table): immutable storage for raw HTML/markdown/screenshots/PDFs; records content hashes, fetch metadata, changeTracking; exposes snapshot refs for provenance and reprocessing. Interfaces: write/read snapshot blobs, `document_snapshots` metadata. (`architecture_components.md`, `architecture_kickoff.md`)
- Extraction Service: deterministic parsing + OpenAI Structured Outputs extraction; optional vision pass; validates schema, requires evidence/confidence per field; produces SourceObservation records. Interfaces: snapshot_id → `source_observations` + Facts/evidence. (`architecture_components.md`, `architecture_kickoff.md`, `_dev_docs/apt_judge.md`)
- Normalization Service: libpostal address parsing + USPS unit designators; normalizes currency, dates, lease terms, fees, amenities; standardizes bed/bath and rent ranges. Interfaces: SourceObservation → normalized fields. (`architecture_components.md`, `architecture_kickoff.md`)
- Dedupe / Entity Resolution Service: blocking + scoring to cluster observations into canonical Building/Unit/Listing; merge policy uses source trust + recency + confidence; thresholds for auto-merge vs review. Interfaces: normalized observations → canonical records + listing_changes. (`architecture_components.md`, `architecture_kickoff.md`)
- Geo/Commute Service: local geocoding (Pelias/Nominatim), routing (OTP + Valhalla/OSRM), isochrone precompute, commute caching; open-data only. Interfaces: normalized address → geocode precision; listings → commute results cache. (`architecture_components.md`, `architecture_kickoff.md`)
- Ranking Service: hard filters → fast scoring → LLM rerank → diversity rerank; generates explanations and missing-info prompts; candidate retrieval via SQL/FTS + embeddings/pgvector. Interfaces: SearchSpec + canonical listings → ranked results + explanations. (`architecture_components.md`, `architecture_kickoff.md`)
- Alert Service: matches change events to SearchSpecs; delivers local notifications or SMTP email digests (no paid SMS). Interfaces: listing_changes + SearchSpecs → alerts. (`architecture_components.md`, `architecture_kickoff.md`)
- API + UI: FastAPI endpoints for search, listing detail, compare, alerts; local web UI (map/list, compare, near-miss explorer); handles NL intake → SearchSpec. Interfaces: user input → SearchSpec; ranking results → UI. (`architecture_components.md`, `architecture_kickoff.md`)
- Evaluation and QA: golden set runner; regression tests for extraction/dedupe/ranking; coverage/freshness dashboards; nightly batch runs for re-extraction/embedding refresh. Interfaces: snapshots/observations/listings → metrics + gates. (`architecture_components.md`, `architecture_kickoff.md`, `_dev_docs/apt_judge.md`)
- Storage and Core Schema: Postgres + PostGIS as system of record; pgvector for embeddings; Redis for queues/caches; object store for raw artifacts; core tables: sources, source_policies, document_snapshots, source_observations, buildings, units, listings, listing_changes, facts, search_specs, matches, alerts. Interfaces: shared persistence layer for all components. (`architecture_components.md`, `architecture_kickoff.md`)

**Data Flows**
1. User NL query → API/UI parses to SearchSpec (hard/soft constraints, commute anchors) and stores it. (`architecture_components.md`, `architecture_kickoff.md`)
2. Acquisition Orchestrator uses SearchSpec + Source Registry/Policy Gate to plan Search/Map/Crawl/Scrape/Import tasks with policy_id, rate limits, and sweep context; Scheduler/Workers execute tasks. (`architecture_components.md`, `architecture_kickoff.md`)
3. Firecrawl Adapter or manual import captures raw artifacts; Snapshot Store persists immutable blobs and `document_snapshots` metadata (content_hash, changeTracking). (`architecture_components.md`, `architecture_kickoff.md`)
4. Extraction Service runs deterministic parsing + OpenAI Structured Outputs (optionally vision), validates schema, and emits `source_observations` with evidence/confidence and extractor_version. (`architecture_components.md`, `architecture_kickoff.md`)
5. Normalization Service standardizes addresses (libpostal + USPS unit designators), currencies, dates, lease terms, fees, and amenity vocab. (`architecture_components.md`, `architecture_kickoff.md`)
6. Dedupe/Entity Resolution clusters observations into canonical Building/Unit/Listing, applies merge policy, and logs listing_changes. (`architecture_components.md`, `architecture_kickoff.md`)
7. Geo/Commute Service geocodes listings locally and computes/caches commute times and isochrones using open-data routing. (`architecture_components.md`, `architecture_kickoff.md`)
8. Ranking Service retrieves candidates (SQL/FTS + pgvector), applies hard filters and scoring, runs LLM rerank and diversity rerank, and returns explanations. (`architecture_components.md`, `architecture_kickoff.md`)
9. Alert Service matches listing_changes to SearchSpecs and sends local notifications or SMTP digests. (`architecture_components.md`, `architecture_kickoff.md`)

**Gaps / Conflicts**
- Conflict: `_dev_docs/apt_judge.md` recommends paid services (Mapbox/Google geocoding, TravelTime/Mapbox matrices, Twilio SMS) which violate the hard constraint “only paid services: Firecrawl + OpenAI” and the open-data/local-only geo/commute posture. (`architecture_kickoff.md`, `_dev_docs/apt_judge.md`)
- Conflict/ambiguity: `_dev_docs/apt_judge.md` includes OpenSearch + a separate vector DB, while the core plan specifies Postgres + pgvector and does not name OpenSearch; the search/index stack needs a single canonical choice. (`architecture_kickoff.md`, `architecture_components.md`, `_dev_docs/apt_judge.md`)
- Gap/overlap: Connector interface defines `extract(snapshot)` while a centralized Extraction Service is a core component; clarify whether connector-specific extraction is allowed or whether connectors only enumerate/fetch and all extraction is centralized. (`architecture_kickoff.md`, `architecture_components.md`, `_dev_docs/apt_judge.md`)
- Gap: Scheduler/queue/worker responsibilities are described, but not captured as a named component in the high-level component spec; boundaries between Acquisition Orchestrator vs Scheduler/Workers are not explicit. (`architecture_components.md`, `architecture_kickoff.md`)
- Gap: SearchSpec creation from NL input is referenced, but no explicit component owner or interface contract is defined (API/UI vs Ranking Service). (`architecture_components.md`, `architecture_kickoff.md`)
- Overlap: “Source Registry and Policy Gate” vs “Connector Registry” both hold source metadata; the authoritative registry and ownership of query templates/sweep config should be clarified. (`architecture_components.md`, `architecture_kickoff.md`, `_dev_docs/apt_judge.md`)
- Ambiguity: `facts` table is optional in the schema outline, yet provenance-first requirements rely on field-level facts and evidence; decide whether Facts are mandatory or derived views. (`architecture_components.md`, `architecture_kickoff.md`)

**Open Questions**
- Queue system choice (Redis/RQ vs Celery vs Postgres-based queue). (`architecture_kickoff.md`)
- Geocoder choice (Pelias vs Nominatim) and routing engine (Valhalla vs OSRM). (`architecture_kickoff.md`)
- UI scope (minimal vs full SPA). (`architecture_kickoff.md`)
- Use of 511 GTFS feeds given licensing restrictions. (`architecture_kickoff.md`)
- Object storage choice (filesystem vs MinIO). (`architecture_kickoff.md`)
- Canonical search/index strategy (Postgres FTS/pgvector vs OpenSearch per apt_judge). (`architecture_kickoff.md`, `_dev_docs/apt_judge.md`)
- Owner/boundary for SearchSpec parsing and connector-specific extraction. (`architecture_kickoff.md`, `_dev_docs/apt_judge.md`)
